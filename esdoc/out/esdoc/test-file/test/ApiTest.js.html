<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">test/ApiTest.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/swagger-api/swagger-ui.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DOBClass.js~DateOfBirth.html">DateOfBirth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DateClass.js~Date.html">Date</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/FlightClass.js~Flight.html">Flight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/LegClass.js~Leg.html">Leg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PassengerCountClass.js~PassengerCount.html">PassengerCount</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PersonDetailsClass.js~PersonDetails.html">PersonDetails</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PurchaseDataClass.js~PurchaseData.html">PurchaseData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SegmentClass.js~Segment.html">Segment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SliceClass.js~Slice.html">Slice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/TripClass.js~Trip.html">Trip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/TripDataClass.js~TripData.html">TripData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseRequest">parseRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseResponse">parseResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-request">request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendAndFollow">sendAndFollow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendRequest">sendRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-XMLHttpRequest">XMLHttpRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-fBird">fBird</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-fBird.get">fBird.get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-fBird.post">fBird.post</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects">dataObjects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.data">dataObjects.data</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.date">dataObjects.date</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.dateOfBirth">dataObjects.dateOfBirth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.flight">dataObjects.flight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.leg">dataObjects.leg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.passengerCounts">dataObjects.passengerCounts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.personInfo">dataObjects.personInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.purchaseData">dataObjects.purchaseData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.segment">dataObjects.segment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.slice">dataObjects.slice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.trip">dataObjects.trip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dataObjects.tripData">dataObjects.tripData</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/ApiTest.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Created by priyanka on 28/4/16.
 */

const chai = require(&apos;chai&apos;);
const expect = require(&apos;chai&apos;).expect;
const assert = require(&apos;chai&apos;).assert;
const sinon = require(&apos;sinon&apos;);
const fBird = require(&apos;../index&apos;);
const btoa = require(&apos;btoa&apos;);
const chaiHttp = require(&apos;chai-http&apos;);
const rewire = require(&quot;rewire&quot;);
const api = require(&apos;../src/api&apos;);
chai.use(chaiHttp);
chai.should();


/** @test {API} */
describe(&apos;API calls&apos;, function() {

    var xhr;
    beforeEach(function() {
        global.XMLHttpRequest = sinon.useFakeXMLHttpRequest();
        this.xhr = sinon.useFakeXMLHttpRequest();
        var requ = this.requests = [];
        this.xhr.onCreate = function(xhr) {
            requ.push(xhr);
        };
        fBird.initialize({
            client_id: &apos;YOUR_CLIENT_ID&apos;,
            redirect_uri: &apos;http://localhost:8181&apos;
        });
    });

    afterEach(function() {
        this.xhr.restore();
    });

    describe(&quot;Authentication&quot;, () =&gt; {
        /** @test {fBird.get /v1/authenticate} */

        it(&quot;should call get and return token&quot;, function(done) {

            var result;
            var token = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;message&quot;: &quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;
            };

            var path = &apos;http://localhost:8181/v1/authenticate&apos;,
                loginData = &apos;userName:password&apos;;
            var mock = sinon.mock(api).expects(&quot;request&quot;)
                .withExactArgs(&apos;GET&apos;, path, loginData).returns(token);
            var expectedResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;message&quot;: &quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;
            };
            result = fBird.get(path, loginData);
            mock.verify();
            done();
            expect(result).to.be.a(&quot;object&quot;);
            expect(result).to.be.not.a(&quot;number&quot;);
            expect(result).to.be.not.a(&quot;string&quot;);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.message).to.equal(expectedResult.message);
        });

        it(&apos;should return the request with the promise&apos;, function() {
            var path = &apos;v1/authenticate&apos;,
                data = &apos;userName:password&apos;;
            var promise = fBird.get(&apos;GET&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            assert.isNotNull(promise.request);
            assert.instanceOf(promise.request, XMLHttpRequest);
        });

        it(&apos;should return the correct status if a request has an empty response&apos;, function() {
            var callback = sinon.spy();
            var data = &apos;userName:passWord&apos;,
                token = &apos;dXNlck5hbWU6cGFzc3dvcmQ=&apos;;

            fBird.get(&apos;v1/authenticate&apos;, data);
            var expectedResult = JSON.stringify({
                &quot;code&quot;: &quot;400&quot;,
                &quot;message&quot;: &quot;No authorization credentials found&quot;
            });
            this.requests[0].respond(400, {
                    &quot;Authorization&quot;: &quot;Basic &quot; + token
                },
                expectedResult);
            var result = this.requests[0].response;
            expect(this.requests.length).to.equal(1);
            callback.calledWith(expectedResult);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.message).to.equal(expectedResult.message);
        });

        it(&apos;should make a GET against trip object&apos;, function(done) {
            fBird.get(&apos;v1/authenticate&apos;, &apos;userName:password&apos;).then(function(res) {
                assert.equal(res.code, 200);
                assert.equal(this.requests[0].method, &apos;GET&apos;);
                done();
            }.bind(this)).catch(function(err) {
                done(err);
            });
            this.requests[0].respond(200, {
                    &apos;Authorization&apos;: &apos;Basic userName:password&apos;
                },
                &apos;{&quot;code&quot;:&quot;200&quot;,&quot;message&quot;:&quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;}&apos;);
        });

        it(&apos;should trigger a promise catch on a 403 with bad JSON&apos;, function(done) {
            fBird.get(&apos;v1/authenticate&apos;, &apos;&apos;).then(function(res) {
                assert(res, 200);
                assert.fail(&apos;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&apos;, res.message);
                //done(res);
            }.bind(this)).catch(function(err) {
                assert.ok(err.actual, &apos;Promise should not resolve&apos;);
                done(err);
                //assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
            });
            this.requests[0].respond(403, {
                    &apos;Authorization&apos;: &apos;Basic userName:password&apos;
                },
                &apos;{&quot;code&quot;:&quot;200&quot;,&quot;message&quot;:&quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;}&apos;);
            done()
        });

        it(&apos;should trigger a promise catch on a 500 with error JSON&apos;, function(done) {
            fBird.get(&apos;v1/authenticate&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
                assert.equal(err.message, &apos;server explosion&apos;);
            });
            this.requests[0].respond(500, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;server explosion&quot;}]}&apos;);
            done();
        });

        it(&apos;should trigger a promise catch on a 404&apos;, function(done) {
            fBird.get(&apos;v1/authenticate&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 404, &apos;error.status is a 404&apos;);
                assert.equal(err.message, &apos;not found&apos;);
            });
            this.requests[0].respond(404, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;not found&quot;}]}&apos;);
            done();
        });

        it(&apos;get basic authenticated token&apos;, function() {
            var path = &apos;v1/authenticate&apos;,
                data = &apos;userName:password&apos;;
            var callback = sinon.spy();
            var promise = api.request(&apos;GET&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            expect(this.requests.length).to.equal(1);
            assert.isNotNull(this.requests);
            this.requests[0].respond(200, {
                &quot;Authorization&quot;: &quot;Basic &quot;
            }, data);
            assert.equal(promise.request.status, 200);
        });

        it(&apos;should return the correct status if a request has an empty response&apos;, function(done) {
            var path = &apos;v1/authenticate&apos;,
                data = &apos;userName:password&apos;;
            var promise = api.request(&apos;GET&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            this.requests[0].respond(200, {
                    &quot;Authorization&quot;: &quot;Basic &quot;
                },
                data);
            assert.equal(promise.request.status, 200);
            // assert.equal(promise.request.message, &apos;HTTP Error: 500&apos;);
            done();
        });
    });

    describe(&quot;pricing&quot;, () =&gt; {

        var data = {
                &quot;missedConnections&quot;: true,
                &quot;passengerCounts&quot;: {
                    &quot;adult&quot;: 1,
                    &quot;child&quot;: 2,
                    &quot;infantInLap&quot;: 0,
                    &quot;infantInSeat&quot;: 0,
                    &quot;senior&quot;: 0
                },
                &quot;data&quot;: {
                    &quot;key1&quot;: &quot;val1&quot;,
                    &quot;kye2&quot;: &quot;val2&quot;
                },
                &quot;slices&quot;: [{
                    &quot;duration&quot;: 0,
                    &quot;segments&quot;: [{
                        &quot;duration&quot;: 10,
                        &quot;flight&quot;: {
                            &quot;airlineCode&quot;: &quot;AA&quot;,
                            &quot;flightNumber&quot;: 124,
                            &quot;date&quot;: {
                                &quot;year&quot;: 2016,
                                &quot;month&quot;: 4,
                                &quot;day&quot;: 4
                            }
                        },
                        &quot;cabin&quot;: &quot;cabin&quot;,
                        &quot;bookingCode&quot;: &quot;bookingCode&quot;,
                        &quot;bookingCodeCount&quot;: &quot;bookingCodeCount&quot;,
                        &quot;data&quot;: {
                            &quot;key1&quot;: &quot;val1&quot;,
                            &quot;kye2&quot;: &quot;val2&quot;
                        },
                        &quot;leg&quot;: [{
                            &quot;aircraft&quot;: &quot;aircraft&quot;,
                            &quot;arrival&quot;: &quot;2016-04-04&quot;,
                            &quot;departure&quot;: &quot;2016-04-04&quot;,
                            &quot;origin&quot;: &quot;ORD&quot;,
                            &quot;destination&quot;: &quot;LAX&quot;,
                            &quot;operatingDisclosure&quot;: &quot;operatingDisclosure&quot;,
                            &quot;changePlane&quot;: &quot;changePlane&quot;,
                            &quot;data&quot;: {
                                &quot;key1&quot;: &quot;val1&quot;,
                                &quot;kye2&quot;: &quot;val2&quot;
                            }
                        }]
                    }]
                }]
            },

            token = &apos;dXNlck5hbWU6cGFzc3dvcmQ=&apos;;
        var expectedResult = JSON.stringify({
            &quot;code&quot;: &quot;200&quot;,
            &quot;data&quot;: {
                &quot;id&quot;: &quot;41008&quot;,
                &quot;priceExpiration&quot;: &quot;2016-05-04T17:29Z&quot;,
                &quot;tripId&quot;: &quot;41016&quot;,
                &quot;data&quot;: {
                    &quot;key1&quot;: &quot;val1&quot;,
                    &quot;kye2&quot;: &quot;val2&quot;
                },
                &quot;regularPrice&quot;: 19.0
            }
        });

        /** @test {fBird.post /v1/pricing} */

        it(&apos;should call pricing API post method&apos;, function(done) {

            var data = dataObjects.data({
                &quot;key1&quot;: &quot;val1&quot;,
                &quot;kye2&quot;: &quot;val2&quot;
            });
            var result;
            var pricingToken = &apos;YWNjZXNzVG9rZW46ZFhObGNrNWhiV1U2V0U1U01HYzFjRE4zTlZZd1ZteHBMMVV2YVhKelFscDZSM1ZKUFRveE5EWXdNakE1T1RNMk56STU=&apos;;
            var path = &apos;http://localhost:8181/v1/pricing&apos;;

            var pricingResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;data&quot;: {
                    &quot;id&quot;: &quot;49256&quot;,
                    &quot;priceExpiration&quot;: &quot;2016-04-22T17:21Z&quot;,
                    &quot;tripId&quot;: &quot;28904&quot;,
                    &quot;data&quot;: {
                        &quot;key1&quot;: &quot;val1&quot;,
                        &quot;kye2&quot;: &quot;val2&quot;
                    },
                    &quot;regularPrice&quot;: 19.0
                }
            };
            var expectedResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;data&quot;: {
                    &quot;id&quot;: &quot;49256&quot;,
                    &quot;priceExpiration&quot;: &quot;2016-04-22T17:21Z&quot;,
                    &quot;tripId&quot;: &quot;28904&quot;,
                    &quot;data&quot;: {
                        &quot;key1&quot;: &quot;val1&quot;,
                        &quot;kye2&quot;: &quot;val2&quot;
                    },
                    &quot;regularPrice&quot;: 19.0
                }
            };
            /* =------------generating trip objects =----------------*/

            var date = dataObjects.date(2016, 4, 4);
            var flight = dataObjects.flight(&apos;AA&apos;, 124, date);
            var passengerCounts = dataObjects.passengerCounts(1, 2, 0, 0, 0);

            var leg = dataObjects.leg(&apos;aircraft&apos;, &apos;2016-04-04&apos;, &apos;2016-04-04&apos;, &apos;ORD&apos;, &apos;LAX&apos;,
                &apos;operatingDisclosure&apos;, &apos;changePlane&apos;, data);
            var segment = dataObjects.segment(10, flight, &apos;cabin&apos;, &apos;bookingCode&apos;, &apos;bookingCodeCount&apos;, data, [leg]);
            var slice = dataObjects.slices(10, [segment]);
            var trip = dataObjects.trip(true, passengerCounts, data, [slice]);
            var mock = sinon.mock(api).expects(&quot;request&quot;)
                .withExactArgs(&apos;POST&apos;, path, trip, pricingToken, &apos;change&apos;).returns(pricingResult);
            result = fBird.post(path, trip, pricingToken, &apos;change&apos;);
            mock.verify();
            done();
            expect(result).to.be.a(&quot;object&quot;);
            expect(result).to.be.not.a(&quot;number&quot;);
            expect(result).to.be.not.a(&quot;string&quot;);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.data.tripId).to.equal(expectedResult.data.tripId);
        });


        it(&apos;should return the request with the promise&apos;, function() {
            var path = &apos;v1/pricing&apos;,
                data = &apos;userName:password&apos;;
            var promise = fBird.get(&apos;GET&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            assert.isNotNull(promise.request);
            assert.instanceOf(promise.request, XMLHttpRequest);

        });

        it(&apos;should return the correct status if a request has an empty response&apos;, function(done) {
            var callback = sinon.spy();

            fBird.post(&apos;v1/pricing&apos;, data);

            this.requests[0].respond(400, {
                    &quot;Authorization&quot;: &quot;Basic &quot; + token
                },
                expectedResult);
            var result = this.requests[0].response;
            expect(this.requests.length).to.equal(1);
            callback.calledWith(expectedResult);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.message).to.equal(expectedResult.message);
            done();
        });

        it(&apos;should make a POST against pricing object&apos;, function(done) {
            fBird.post(&apos;v1/pricing&apos;, data).then(function(res) {
                assert.equal(res.code, 200);
                assert.equal(this.requests[0].method, &apos;POST&apos;);
                done();
            }.bind(this)).catch(function(err) {
                done(err);
            });
            this.requests[0].respond(200, {
                    &apos;Authorization&apos;: &apos;Basic &apos; + token
                },
                expectedResult);
        });

        it(&apos;should trigger a promise catch on a 403 with bad JSON&apos;, function() {
            fBird.post(&apos;v1/pricing&apos;, &apos;&apos;).then(function(res) {
                assert(res, 200);
                //assert.fail(&apos;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&apos;, res.message);
            }.bind(this)).catch(function(err) {
                assert.ok(err.actual, &apos;Promise should not resolve&apos;);
                //assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
            });
            this.requests[0].respond(403, {
                    &apos;Authorization&apos;: &apos;Basic userName:password&apos;
                },
                &apos;{&quot;code&quot;:&quot;200&quot;,&quot;message&quot;:&quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;}&apos;);
        });

        it(&apos;should trigger a promise catch on a 500 with error JSON&apos;, function(done) {
            fBird.post(&apos;v1/pricing&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
                assert.equal(err.message, &apos;server explosion&apos;);
            });
            this.requests[0].respond(500, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;server explosion&quot;}]}&apos;
            );
            done();
        });

        it(&apos;should trigger a promise catch on a 404&apos;, function(done) {
            fBird.post(&apos;v1/pricing&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 404, &apos;error.status is a 404&apos;);
                assert.equal(err.message, &apos;not found&apos;);
            });
            this.requests[0].respond(404, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;not found&quot;}]}&apos;
            );
            done();
        });

        it(&apos;should return the request with the promise in pricing api&apos;, function(done) {
            var path = &apos;v1/pricing&apos;,
                pricingToken = &apos;YWNjZXNzVG9rZW46ZFhObGNrNWhiV1U2V0U1U01HYzFjRE4zTlZZd1ZteHBMMVV2YVhKelFscDZSM1ZKUFRveE5EWXdNakE1T1RNMk56STU=&apos;,
                invalidToken = &apos;YWNjZXNzVG9rZW46ZFhObGNrNWhiV1U2V0U1U01HYzFjRE4zTlZZd1ZteHBMMVV2YVhKelFscDZSM1ZKUFRveE5EWXdNakE1T1RNMk56&apos;;
            /* =------------generating trip objects =----------------*/
            var pricingResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;data&quot;: {
                    &quot;id&quot;: &quot;49256&quot;,
                    &quot;priceExpiration&quot;: &quot;2016-04-22T17:21Z&quot;,
                    &quot;tripId&quot;: &quot;28904&quot;,
                    &quot;data&quot;: {
                        &quot;key1&quot;: &quot;val1&quot;,
                        &quot;kye2&quot;: &quot;val2&quot;
                    },
                    &quot;regularPrice&quot;: 19.0
                }
            };
            var date = dataObjects.date(2016, 4, 4);
            var flight = dataObjects.flight(&apos;AA&apos;, 124, date);
            var passengerCounts = dataObjects.passengerCounts(1, 2, 0, 0, 0);
            var data = dataObjects.data({
                &quot;key1&quot;: &quot;val1&quot;,
                &quot;kye2&quot;: &quot;val2&quot;
            });
            var leg = dataObjects.leg(&apos;aircraft&apos;, &apos;2016-04-04&apos;, &apos;2016-04-04&apos;, &apos;ORD&apos;, &apos;LAX&apos;,
                &apos;operatingDisclosure&apos;, &apos;changePlane&apos;, data);
            var segment = dataObjects.segment(10, flight, &apos;cabin&apos;, &apos;bookingCode&apos;, &apos;bookingCodeCount&apos;, data, [leg]);
            var slice = dataObjects.slices(10, [segment]);
            var trip = dataObjects.trip(true, passengerCounts, data, [slice]);


            // var promise = api.request(&apos;POST&apos;, path, trip, pricingToken, &apos;change&apos;);
            var invalidTokenRequest = api.request(&apos;POST&apos;, path, trip, invalidToken, &apos;change&apos;);
            assert.isNotNull(invalidTokenRequest.request);
            assert.instanceOf(invalidTokenRequest.request, XMLHttpRequest);
            expect(pricingResult).to.be.a(&quot;object&quot;);
            expect(pricingResult).to.be.not.a(&quot;number&quot;);
            expect(pricingResult).to.be.not.a(&quot;string&quot;);
            done();
        });

        it(&apos;should return the correct status if a request has an empty response&apos;, function(done) {
            var path = &apos;v1/pricing&apos;
            var promise = api.request(&apos;POST&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            this.requests[0].respond(200, {
                    &quot;Authorization&quot;: &quot;Basic &quot;
                },
                JSON.stringify(data));
            assert.equal(promise.request.status, 200);
            // assert.equal(promise.request.message, &apos;HTTP Error: 500&apos;);
            done();
        });
    });

    describe(&quot;Purchase&quot;, () =&gt; {

        var data = {
            &quot;priceRequestId&quot;: &quot;24776&quot;,
            &quot;clientNonce&quot;: &quot;string&quot;,
            &quot;priceTier&quot;: &quot;GOLD&quot;,
            &quot;trip&quot;: {
                &quot;id&quot;: &quot;78000&quot;,
                &quot;personInfo&quot;: [{
                    &quot;gender&quot;: &quot;male&quot;,
                    &quot;firstName&quot;: &quot;string&quot;,
                    &quot;lastName&quot;: &quot;string&quot;,
                    &quot;middleName&quot;: &quot;string&quot;,
                    &quot;dateOfBirth&quot;: {
                        &quot;year&quot;: 1990,
                        &quot;month&quot;: 1,
                        &quot;day&quot;: 1
                    },
                    &quot;phone&quot;: &quot;string&quot;,
                    &quot;email&quot;: &quot;string&quot;,
                    &quot;isDeciderToPay&quot;: true,
                    &quot;isPayer&quot;: true,
                    &quot;isPassenger&quot;: true,
                    &quot;isBookingPerson&quot;: true
                }]
            },
            &quot;pciTransactionId&quot;: &quot;pciTransactionId&quot;,
            &quot;data&quot;: {
                &quot;key1&quot;: &quot;val1&quot;,
                &quot;kye2&quot;: &quot;val2&quot;
            }
        };

        var token = &apos;dXNlck5hbWU6cGFzc3dvcmQ=&apos;;

        var expectedResult = JSON.stringify({
            &quot;purchaseId&quot;: &quot;32880&quot;,
            &quot;purchaseTotal&quot;: 19.0,
            &quot;priceRequestId&quot;: &quot;24776&quot;,
            &quot;encClientNonce&quot;: &quot;SHA256Base64url&quot;,
            &quot;trip&quot;: {
                &quot;id&quot;: &quot;78000&quot;,
                &quot;data&quot;: {
                    &quot;key1&quot;: &quot;val1&quot;,
                    &quot;kye2&quot;: &quot;val2&quot;
                }
            },
            &quot;pciTransactionId&quot;: &quot;pciTransactionId&quot;,
            &quot;data&quot;: {
                &quot;key1&quot;: &quot;val1&quot;,
                &quot;kye2&quot;: &quot;val2&quot;
            }
        });

        /** @test {fBird.post /v1/purchase} */

        it(&apos;should call purchase API post method&apos;, function(done) {

            var data = dataObjects.data({
                &quot;key1&quot;: &quot;val1&quot;,
                &quot;kye2&quot;: &quot;val2&quot;
            });
            var result;
            var pricingToken = &apos;YWNjZXNzVG9rZW46ZFhObGNrNWhiV1U2V0U1U01HYzFjRE4zTlZZd1ZteHBMMVV2YVhKelFscDZSM1ZKUFRveE5EWXdNakE1T1RNMk56STU=&apos;;
            var path = &apos;http://localhost:8181/v1/purchase&apos;;
            var purchaseResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;data&quot;: {
                    &quot;id&quot;: &quot;49256&quot;,
                    &quot;priceExpiration&quot;: &quot;2016-04-22T17:21Z&quot;,
                    &quot;tripId&quot;: &quot;28904&quot;,
                    &quot;data&quot;: {
                        &quot;key1&quot;: &quot;val1&quot;,
                        &quot;kye2&quot;: &quot;val2&quot;
                    },
                    &quot;regularPrice&quot;: 19.0
                }
            };
            var expectedResult = {
                &quot;code&quot;: &quot;200&quot;,
                &quot;data&quot;: {
                    &quot;id&quot;: &quot;49256&quot;,
                    &quot;priceExpiration&quot;: &quot;2016-04-22T17:21Z&quot;,
                    &quot;tripId&quot;: &quot;28904&quot;,
                    &quot;data&quot;: {
                        &quot;key1&quot;: &quot;val1&quot;,
                        &quot;kye2&quot;: &quot;val2&quot;
                    },
                    &quot;regularPrice&quot;: 19.0
                }
            };
            /* =------------generating purchase objects =----------------*/

            var dateOfBirth = dataObjects.dateOfBirth(1990, 1, 1);
            var personInfo = dataObjects.personInfo(&apos;male&apos;, &apos;string&apos;, &apos;string&apos;, &apos;string&apos;, dateOfBirth, &apos;string&apos;, &apos;string&apos;, true, true, true, true);
            var tripdata = dataObjects.tripData(result.data.tripId, [personInfo]);
            var purchase = dataObjects.purchaseData(result.data.id, &apos;string&apos;, &apos;GOLD&apos;, tripdata, &apos;pciTransactionId&apos;, data);

            var mock = sinon.mock(api).expects(&quot;request&quot;)
                .withExactArgs(&apos;POST&apos;, path, purchase, pricingToken, &apos;change&apos;).returns(purchaseResult);
            result = fBird.post(path, purchase, pricingToken, &apos;change&apos;);
            mock.verify();
            done();
            expect(result).to.be.a(&quot;object&quot;);
            expect(result).to.be.not.a(&quot;number&quot;);
            expect(result).to.be.not.a(&quot;string&quot;);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.data.tripId).to.equal(expectedResult.data.tripId);
        });


        it(&apos;should return the request with the promise&apos;, function() {
            var path = &apos;v1/purchase&apos;,
                data = &apos;userName:password&apos;;
            var promise = fBird.get(&apos;GET&apos;, path, data, &apos;&apos;, &apos;noChange&apos;);
            assert.isNotNull(promise.request);
            assert.instanceOf(promise.request, XMLHttpRequest);
        });

        it(&apos;should return the correct status if a request has an empty response&apos;, function() {
            var callback = sinon.spy();

            fBird.post(&apos;v1/purchase&apos;, data);

            this.requests[0].respond(400, {
                    &quot;Authorization&quot;: &quot;Basic &quot; + token
                },
                expectedResult);
            var result = this.requests[0].response;
            expect(this.requests.length).to.equal(1);
            callback.calledWith(expectedResult);
            expect(result.code).to.equal(expectedResult.code);
            expect(result.message).to.equal(expectedResult.message);
        });

        it(&apos;should make a POST against purchase object&apos;, function(done) {

            fBird.post(&apos;v1/purchase&apos;, data).then(function(res) {
                assert.equal(this.requests[0].method, &apos;POST&apos;);
                done();
            }.bind(this)).catch(function(err) {
                done(err);
            });
            this.requests[0].respond(200, {
                    &apos;Authorization&apos;: &apos;Basic &apos; + token
                },
                expectedResult);
        });

        it(&apos;should trigger a promise catch on a 403 with bad JSON&apos;, function(done) {
            fBird.post(&apos;v1/purchase&apos;, &apos;&apos;).then(function(res) {
                assert(res, 200);
                //assert.fail(&apos;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&apos;, res.message);
                //done(res);
            }.bind(this)).catch(function(err) {
                assert.ok(err.actual, &apos;Promise should not resolve&apos;);
                done(err);
                //assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
            });
            this.requests[0].respond(403, {
                    &apos;Authorization&apos;: &apos;Basic userName:password&apos;
                },
                &apos;{&quot;code&quot;:&quot;200&quot;,&quot;message&quot;:&quot;dXNlck5hbWU6WE5SMGc1cDN3NVYwVmxpL1UvaXJzQlp6R3VJPToxNDYwMjA5OTM2NzI5&quot;}&apos;);
            done()
        });

        it(&apos;should trigger a promise catch on a 500 with error JSON&apos;, function(done) {
            fBird.post(&apos;v1/purchase&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 500, &apos;error.status is a 500&apos;);
                assert.equal(err.message, &apos;server explosion&apos;);
            });
            this.requests[0].respond(500, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;server explosion&quot;}]}&apos;
            );
            done();
        });

        it(&apos;should trigger a promise catch on a 404&apos;, function(done) {
            fBird.post(&apos;v1/purchase&apos;).then(function(res) {
                assert.fail(&apos;Promise should not resolve&apos;);
            }.bind(this)).catch(function(err) {
                assert.ok(err, &apos;Promise.catch is sent and error object&apos;);
                assert.equal(err.status, 404, &apos;error.status is a 404&apos;);
                assert.equal(err.message, &apos;not found&apos;);
            });
            this.requests[0].respond(404, {
                    &apos;Content-Type&apos;: &apos;text/json&apos;
                },
                &apos;{&quot;errors&quot;: [{&quot;error_message&quot;: &quot;not found&quot;}]}&apos;
            );
            done();
        });
    });
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
